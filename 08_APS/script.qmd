---
title: "sisab"
format: html
editor: visual
---

## Tratamento dados APS

O objetivo do presente script é realizar um tratamento para juntar as contendo população vulnerável e população vinculada à APS em cada município. 

```{r}
#| warning: false

library(tidyverse)
library(readxl)

cadastro_pop_sisab <- read_excel("bases/cadastro_pop_sisab.xls")

cadastro_pop_sisab$CNES <- as.integer(cadastro_pop_sisab$CNES)

pop_vulneravel_previne_202212 <- read_excel("bases/pop_vulneravel_previne_202212.xlsx")

pop_vulneravel_previne_202212$CO_CNES <- as.integer(pop_vulneravel_previne_202212$CO_CNES)

```


Juntando as duas bases 

```{r}

sisab <- cadastro_pop_sisab %>% 
            left_join(pop_vulneravel_previne_202212, by = c("CNES"="CO_CNES")) %>% 
            janitor::clean_names() %>% 
            select(uf, ibge, municipio, cnes, estabelecimento, 
                   pop_vinc, qt_bnf_auxilio_brasil) %>% 
            mutate(pop_vinc = as.numeric(pop_vinc)) %>% 
            mutate(perc_benef = qt_bnf_auxilio_brasil/pop_vinc)

```

Agora vamos calcular o grau de vulnerabilidade de cada unidade por município. Vamos fazer um exemplo para Águas Lindas de Goiás. 

```{r}

aguas_lindas <- 
  sisab %>% 
  filter(ibge == '520025') %>% 
  mutate(classificacao = case_when(perc_benef <= quantile(perc_benef, 0.33) ~ 'baixa vulnerabilidade',
                                   perc_benef > quantile(perc_benef, 0.33) & 
                                   perc_benef <= quantile(perc_benef, 0.66) ~ 'média vulnerabilidade',
                                   perc_benef > quantile(perc_benef, 0.66) ~ 'alta vulnerabilidade'))


```

Vamos aplicar a lógica para todos os municípios.  

```{r}
teste <- 
sisab %>% 
  filter(perc_benef != "NA") %>% 
  mutate(classificacao = case_when(perc_benef <= quantile(perc_benef, 0.33) ~ 'baixa vulnerabilidade',
                                   perc_benef > quantile(perc_benef, 0.33) & 
                                   perc_benef <= quantile(perc_benef, 0.66) ~ 'média vulnerabilidade',
                                   perc_benef > quantile(perc_benef, 0.66) ~ 'alta vulnerabilidade'), .by = c(uf, ibge, municipio))


```

Agora vamos determinar a quantidade de equipes de acordo com o grau de vulnerabilidade

```{r}

equipes <- 
  teste %>% 
    mutate(equipes = case_when(classificacao == 'baixa vulnerabilidade' ~ pop_vinc/3500, 
                               classificacao == 'média vulnerabilidade' ~ pop_vinc/2500,
                               classificacao == 'alta vulnerabilidade' ~ pop_vinc/2000)) %>% 
    mutate(medicos = equipes,
           enfermeiros = equipes,
           tecnicos = 2 * equipes,
           acs = pop_vinc/750)

#writexl::write_xlsx(equipes, 'equipes.xlsx')

```

Vamos determinar o número de profissionais por município considerando o número de equipes. 

```{r}

prof_municipio <- 
        equipes %>% 
        group_by(uf, ibge, municipio) %>% 
        summarise(total_equipe = sum(equipes),
                  total_pop = sum(pop_vinc)) %>% 
        mutate(medicos = total_equipe,
               enfermeiros = total_equipe,
               tecnicos = total_equipe * 2,
               acs = total_pop/750)

#writexl::write_xlsx(prof_municipio, 'municipios.xlsx')

```





