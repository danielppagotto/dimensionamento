---
title: "Indicadores"
date: "25/05/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
library(tidyverse)
library(roperators)

if (!require(RODBC)) { install.packages(RODBC); require(RODBC) }

setwd("~/GitHub/dimensionamento/Demanda maio 2022/Demandas")

dremio_host <- "200.137.215.27"
dremio_port <- "31010"
dremio_uid <- "daniel"
dremio_pwd <- Sys.getenv("datalake")

channel <- odbcDriverConnect(sprintf("DRIVER=Dremio Connector;HOST=%s;PORT=%s;UID=%s;PWD=%s;AUTHENTICATIONTYPE=Basic Authentication;CONNECTIONTYPE=Direct", dremio_host, dremio_port, dremio_uid, dremio_pwd))


```

## **Indicador 1 - Estabelecimentos hospitalares já existentes com ampliação de leitos covid-19** 

**Instrução:** Estabelecimento anteriores a 2020, com registro de leitos covid-19 (com as Descrições: “51-UTI II ADULTO-SINDROME RESP. AGUDA GRAVE (SRAG)-COVID-19” ou “52"- UTI II PEDIATRICA-SINDROME RESP. AGUDA GRAVE (SRAG)-COVID-19” ou “96- SUPORTE VENTILATÓRIO PULMONAR - COVID-19”).

#### Baixando os dados

```{r pressure, echo=FALSE, message=FALSE, warning=FALSE}

df <- sqlQuery(channel, 'SELECT a.CNES, FANTASIA, RAZ_SOCI, RSOC_MAN, 
                                a.CODUFMUN, municipio_pad, a.uf, regiao, TPGESTAO, a.CPF_CNPJ,
                                a.NIV_DEP, a.TP_UNID, CODLEITO, QT_EXIST, QT_CONTR, QT_SUS, 
                                QT_NSUS, COMPETEN, competencia
                        FROM Dados.cnes.LT a
                        LEFT JOIN Dados.cnes.CADGER b
                        ON a.CNES = b.CNES
                        LEFT JOIN "Analytics Layer".Territorial."Municípios - Hierarquia Completa" c
                        ON CAST(a.CODUFMUN AS INT) = c.cod_municipio
                        WHERE substr(COMPETEN, 1, 4) > 2018')

df$CNES <- as.character(df$CNES)

```

Primeiramente, preciso saber quais eram os estabelecimentos que já existiam em 2019. Para feitos de análise, foram acessados os estabelecimentos nas competências 12 (Dezembro) de 2019. 

```{r}

cnes_2019 <- df %>% 
  filter(COMPETEN == "201912") %>% 
  distinct(CNES, FANTASIA, RAZ_SOCI)

cnes_2019c <- cnes_2019$CNES  


leitos <- c(51, 52, 96)

cnes_20_21_exist <- df %>% 
  filter(COMPETEN == "202012" | COMPETEN == "202112") %>% 
  filter(CNES %in% cnes_2019c) %>% 
  filter(CODLEITO %in% leitos) %>% 
  select(COMPETEN, uf, CODUFMUN, municipio_pad, regiao,  CNES, FANTASIA, RAZ_SOCI, 
         CODLEITO, QT_EXIST) 
  
  
```

Os estabelecimentos que cumprem os requisitos estão listados abaixo. 

```{r echo=FALSE}
DT::datatable(cnes_20_21_exist)
```

Temos a seguinte situação em termos de leitos no último mês de 2020 e 2021, respectivamente. 

```{r}

c <- cnes_20_21_exist %>% 
  mutate(Ano = as.integer(substr(COMPETEN, 1, 4))) %>% 
  group_by(Ano, regiao) %>% 
  summarise(qtd_existente = sum(QT_EXIST)) %>% 
  ggplot(aes(x = Ano, y = qtd_existente, col = regiao)) + geom_line() + 
  scale_x_continuous(breaks = seq(2020,2021,1)) +
  theme_minimal() + ylab("Quantidade existente") + ggtitle("Quantidade de leitos existentes",
                                                           "Fonte: CNES-LT")

  
  
plotly::ggplotly(c)  
  
```


O próximo passo é identificar quantos hospitais que já existiam em 2019 e tinham leitos covid em 2020 e 2021. 

```{r}

cnes20 <- cnes_20_21_exist %>% 
  filter(COMPETEN == "202012") %>% 
  distinct(CNES, FANTASIA, RAZ_SOCI, uf, regiao) %>% 
  group_by(regiao) %>% 
  summarise(total = n()) %>% 
  mutate(ano = 2020)
   
  
cnes20_c <- cnes_20_21_exist %>% 
              filter(COMPETEN == "202012") %>% 
              distinct(CNES)

cnes20_c <- cnes20_c$CNES


cnes21 <- cnes_20_21_exist %>% 
            filter(COMPETEN == "202112") %>% 
            filter(CNES %ni% cnes20_c) %>% 
            distinct(CNES, FANTASIA, RAZ_SOCI, uf, regiao) %>% 
            group_by(regiao) %>% 
            summarise(total = n()) %>% 
            mutate(ano = 2021)

cnes_novos <- rbind(cnes20, cnes21)

d <- cnes_existentes %>% 
      ggplot(aes(x = ano, y = total, fill = regiao)) + geom_col(position = "dodge") +  
      theme_minimal() +  scale_x_continuous(breaks = seq(2020,2021,1)) + 
      ylab("Quantidade de estabelecimentos") + ggtitle("Quantidade de estabelecimentos existentes em cada ano",
                                                       "Fonte: CNES-LT")

plotly::ggplotly(d)

```


## **Indicador 2 - Estabelecimentos hospitalares novos com estrutura (serviços) para covid-19**

**Instrução**: Estabelecimentos criados entre 2020 e 2021, com o termo “COVID” em seu nome fantasia e (+) aqueles com leito com as descrições: “51-UTI II ADULTO-SINDROME RESP. AGUDA GRAVE (SRAG)-COVID-19” ou “52 - UTI II PEDIATRICA-SINDROME RESP. AGUDA GRAVE (SRAG)-COVID-19” ou “96- SUPORTE VENTILATÓRIO PULMONAR - COVID-19”).


Primeiramente, preciso saber quais eram os estabelecimentos que foram criados nos anos de 2020 e 2021. Para isso, vou excluir todos os estabelecimentos que já existiam em 2019, pegando apenas os novos os anos subsequentes. 

Para feitos de análise, foram acessados os estabelecimentos nas competências 12 (Dezembro) de cada ano.


```{r}

cnes_2019 <- df %>% 
  filter(COMPETEN == "201912") %>% 
  distinct(CNES, FANTASIA, RAZ_SOCI)

cnes_2019c <- cnes_2019$CNES  


leitos <- c(51, 52, 96)

cnes_20_21_novos <- df %>% 
  filter(COMPETEN == "202012" | COMPETEN == "202112") %>% 
  filter(CNES %ni% cnes_2019c) %>% 
  filter(str_detect(FANTASIA, "covid") | CODLEITO %in% leitos) %>% 
  select(COMPETEN, uf, CODUFMUN, municipio_pad, regiao,  CNES, FANTASIA, RAZ_SOCI, 
         CODLEITO, QT_EXIST) 
  
  
```

Os estabelecimentos que cumprem os requisitos estão listados abaixo. 

```{r echo=FALSE}
DT::datatable(cnes_20_21_novos)
```

Temos a seguinte situação em termos de leitos no último mês de 2020 e 2021 respectivamente. 

```{r}

a <- cnes_20_21_novos %>% 
  mutate(Ano = as.integer(substr(COMPETEN, 1, 4))) %>% 
  group_by(Ano, regiao) %>% 
  summarise(qtd_existente = sum(QT_EXIST)) %>% 
  ggplot(aes(x = Ano, y = qtd_existente, col = regiao)) + geom_line() + 
  scale_x_continuous(breaks = seq(2020,2021,1)) +
  theme_minimal() + ylab("Quantidade existente") + ggtitle("Quantidade de leitos existentes",
                                                           "Fonte: CNES-LT")

  
  
plotly::ggplotly(a)  
  
```


O próximo passo é identificar quantos hospitais novos foram criados cada ano 

```{r}

cnes20 <- cnes_20_21_novos %>% 
  filter(COMPETEN == "202012") %>% 
  distinct(CNES, FANTASIA, RAZ_SOCI, uf, regiao) %>% 
  group_by(regiao) %>% 
  summarise(total = n()) %>% 
  mutate(ano = 2020)
   
  
cnes20_c <- cnes_20_21_novos %>% 
              filter(COMPETEN == "202012") %>% 
              distinct(CNES)

cnes20_c <- cnes20_c$CNES


cnes21 <- cnes_20_21_novos %>% 
            filter(COMPETEN == "202112") %>% 
            filter(CNES %ni% cnes20_c) %>% 
            distinct(CNES, FANTASIA, RAZ_SOCI, uf, regiao) %>% 
            group_by(regiao) %>% 
            summarise(total = n()) %>% 
            mutate(ano = 2021)

cnes_novos <- rbind(cnes20, cnes21)

b <- cnes_novos %>% 
      ggplot(aes(x = ano, y = total, fill = regiao)) + geom_col(position = "dodge") +  
      theme_minimal() +  scale_x_continuous(breaks = seq(2020,2021,1)) + 
      ylab("Quantidade de estabelecimentos") + ggtitle("Quantidade de estabelecimentos novos em cada ano",
                                                       "Fonte: CNES-LT")

plotly::ggplotly(b)

```


O gráfico acima apresenta o total de estabelecimentos criados segundo as instruções do indicador nos últimos dois anos. 

## **Indicador 3 - Respiradores cadastrados nos estabelecimento hospitalares já existentes**

**Instruções**: não há instrução para este indicador. Suponho que neste caso, precisamos contabilizar o total por hospitais que já existiam, alinhado ao indicador 1. O respirador é um equipamento cujo código é 64. 

```{r}
df3 <- sqlQuery(channel, 'SELECT a.COMPETEN, a.CNES, a.CODUFMUN, municipio_pad, a.uf, regiao, SUM(QT_EXIST) AS QTD  
                          FROM Dados.cnes.EQ a
                          LEFT JOIN "Analytics Layer".Territorial."Municípios - Hierarquia Completa" c
                                                  ON CAST(a.CODUFMUN AS INT) = c.cod_municipio
                          WHERE CAST(CODEQUIP AS INT) = 64
                          GROUP BY CNES, CODUFMUN, COMPETEN, municipio_pad, a.uf, regiao')
```

Vamos pegar os mesmos estabelecimentos que filtramos no indicador 1. 


```{r}

df3_t <- df3 %>% 
  filter(CNES %in% cnes_2019c) %>% 
  mutate(mes_ano = lubridate::ym(COMPETEN)) %>% 
  group_by(regiao, mes_ano) %>% 
  summarise(total = sum(QTD)) %>% 
  filter(mes_ano > "2019-12-01") %>% 
  filter(regiao != "NA")

DT::datatable(df3_t)

```

```{r}

e <- df3_t %>% 
  ggplot(aes(x = mes_ano, y = total, col = regiao)) + geom_line() + 
  facet_wrap(~regiao, scales = "free_y") + theme_minimal() +
  scale_x_date(date_breaks = "1 year") + theme(legend.position="none")


plotly::ggplotly(e)

```


## **Indicador 4 - Respiradores cadastrados nos estabelecimentos hospitalares já existentes NOVOS PARA COVID**

Vamos levantar o número de respiradores naqueles estabelecimentos que incluíram leitos covid apenas a partir de 2020, conforme extraído no indicador 2.

```{r}
df_4 <- df3 %>% 
  filter(CNES %ni% cnes_2019c) %>% 
  mutate(mes_ano = lubridate::ym(COMPETEN)) %>% 
  group_by(regiao, mes_ano) %>% 
  summarise(total = sum(QTD)) %>% 
  filter(mes_ano > "2019-12-01") %>% 
  filter(regiao != "NA")

DT::datatable(df_4)

```

```{r}
f <- df_4 %>% 
  ggplot(aes(x = mes_ano, y = total, col = regiao)) + geom_line() + 
  facet_wrap(~regiao, scales = "free_y") + theme_minimal() +
  scale_x_date(date_breaks = "1 year") + theme(legend.position="none")


plotly::ggplotly(f)
```



## **Indicador 5 - Internação em UTI covid-19 por estabelecimento de saúde, conforme os indicadores apontados nas linhas 1 e 2 acima** 

## ** Mortalidade por covid-19 em UTI Covid-19 por estabelecimento de saúde, conforme os indicadores apontados nas linhas 1 e 2 acima**

## ** Média de duração da internação em UTI Covid-19, por estabelecimento de saúde, conforme os indicadores apontados nas linhas 1 e 2 acima**




